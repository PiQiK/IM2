<!DOCTYPE html>
<html lang="en" x-data="paymentApp()" x-init="loadOrder()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment - HIDDEN EATS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-orange-50 min-h-screen font-['Raleway'] flex items-center justify-center px-4">

  <div class="bg-white shadow-xl rounded-lg p-6 w-full max-w-lg" x-show="!showThanks">
    <h1 class="text-2xl font-bold text-center text-orange-500 mb-4">Finalize Payment</h1>

    <template x-if="!order">
      <p class="text-center text-gray-500">No order found.</p>
    </template>

    <template x-if="order">
      <div>
        <p class="text-sm text-gray-700 mb-2"><strong>Order Type:</strong> <span x-text="order.orderType"></span></p>
        <p class="text-sm text-gray-700 mb-2"><strong>Total:</strong> ₱<span x-text="order.total"></span></p>

        <!-- Payment Method Selection -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Choose Payment Method:</label>
          <div class="flex space-x-4">
            <button
              :class="paymentMethod === 'Cash' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700'"
              @click="paymentMethod = 'Cash'"
              class="px-4 py-2 rounded hover:bg-yellow-600"
            >Cash</button>

            <button
              :class="paymentMethod === 'GCash' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'"
              @click="paymentMethod = 'GCash'"
              class="px-4 py-2 rounded hover:bg-purple-700"
            >GCash</button>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="max-h-40 overflow-y-auto border rounded p-2 mb-4">
          <ul class="text-sm text-gray-700 space-y-1">
            <template x-for="item in order.cart" :key="item.name">
              <li>
                <span x-text="item.name"></span> × <span x-text="item.qty"></span> — ₱<span x-text="(item.price * item.qty).toFixed(2)"></span>
              </li>
            </template>
          </ul>
        </div>

        <!-- Payment Instructions -->
        <template x-if="paymentMethod === 'GCash'">
          <div class="text-center mb-4">
            <p class="text-sm text-gray-600 mb-2">Scan the GCash QR code below and show your phone to the cashier.</p>
            <img src="gcash_qr.png" alt="GCash QR Code" class="mx-auto w-40 h-40 border rounded shadow"/>
          </div>
        </template>

        <template x-if="paymentMethod === 'Cash'">
          <div class="text-center text-sm text-gray-600 mb-4">
            Please proceed to the cashier and pay your total: <strong>₱<span x-text="order.total"></span></strong>
          </div>
        </template>

        <!-- Buttons -->
        <div class="flex justify-between mt-6">
          <button
            @click="goBackToOrdering"
            class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-gray-800"
          >
            ← Back to Menu
          </button>

          <button
            @click="submitOrder"
            :disabled="!paymentMethod"
            class="px-4 py-2 rounded text-white disabled:opacity-50 disabled:cursor-not-allowed"
            :class="paymentMethod === 'Cash' ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-purple-600 hover:bg-purple-700'"
          >
            Confirm & Proceed to Cashier →
          </button>
        </div>
      </div>
    </template>
  </div>

  <!-- Thank You Message -->
  <div
    x-show="showThanks"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white p-6 rounded-xl shadow-xl text-center w-full max-w-sm">
      <h2 class="text-2xl font-bold text-green-600 mb-3">✅ Thank You!</h2>
      <p class="text-gray-700 mb-1">Your order has been placed.</p>
      <p class="text-gray-700 mb-4">Please proceed to the cashier.</p>
      <p class="text-sm text-gray-500 mb-2">
        Order Number: <span class="font-bold text-black" x-text="orderNumber"></span>
      </p>
      <p class="text-xs text-gray-400">Redirecting back to menu...</p>
    </div>
  </div>

  <script>
    function paymentApp() {
      return {
        order: null,
        paymentMethod: '',
        showThanks: false,
        orderNumber: '',
        loadOrder() {
          const data = localStorage.getItem('pendingOrder');
          if (data) {
            this.order = JSON.parse(data);
          }
        },
        goBackToOrdering() {
          window.location.href = 'index.html';
        },
        submitOrder() {
          if (!this.order || !this.paymentMethod) return;

          const receipt = {
            ...this.order,
            paymentMethod: this.paymentMethod,
            orderNumber: 'HE' + Math.floor(100000 + Math.random() * 900000),
            timestamp: new Date().toLocaleString()
          };

         fetch('submit_order.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(receipt)
            })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              localStorage.removeItem('cart');
              localStorage.removeItem('pendingOrder');

              this.orderNumber = receipt.orderNumber;
              this.showThanks = true;

              setTimeout(() => {
                window.location.href = 'welcome.html';
              }, 6000);
            } else {
              alert('Something went wrong. Please inform the cashier.');
              console.error(data.message);
            }
          })
          .catch(async (err) => {
            const text = await err.text?.();
            console.log("Full error response:", text || err);
            console.log("Fetch error:", err);
            alert('Server error. Please inform the cashier.');
            });
        }
      }
    }
  </script>
</body>
</html>
